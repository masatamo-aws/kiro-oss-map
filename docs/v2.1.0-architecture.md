# ğŸ—ï¸ Kiro OSS Map v2.1.0 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v2.1.0 - ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–ãƒ»CI/CDçµ±åˆ  
**ä½œæˆæ—¥**: 2025å¹´8æœˆ19æ—¥  
**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Cloud Nativeãƒ»ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹  
**å“è³ªç›®æ¨™**: Cloud Native Ready â˜ï¸

---

## ğŸ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ğŸŒŸ è¨­è¨ˆåŸå‰‡

#### Cloud Native åŸå‰‡
- **ã‚³ãƒ³ãƒ†ãƒŠåŒ–**: ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œ
- **å‹•çš„ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Kubernetesã«ã‚ˆã‚‹è‡ªå‹•ç®¡ç†
- **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹**: ç–çµåˆãƒ»ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
- **å®£è¨€çš„API**: Infrastructure as Code
- **è¦³æ¸¬å¯èƒ½æ€§**: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

#### 12-Factor App æº–æ‹ 
1. **ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹**: å˜ä¸€ãƒªãƒã‚¸ãƒˆãƒªãƒ»è¤‡æ•°ãƒ‡ãƒ—ãƒ­ã‚¤
2. **ä¾å­˜é–¢ä¿‚**: æ˜ç¤ºçš„å®£è¨€ãƒ»åˆ†é›¢
3. **è¨­å®š**: ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹å¤–éƒ¨åŒ–
4. **ãƒãƒƒã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹**: ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹
5. **ãƒ“ãƒ«ãƒ‰ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ»å®Ÿè¡Œ**: å³å¯†ãªåˆ†é›¢
6. **ãƒ—ãƒ­ã‚»ã‚¹**: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ãƒ»ã‚·ã‚§ã‚¢ãƒ¼ãƒ‰ãƒŠãƒƒã‚·ãƒ³ã‚°
7. **ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°**: ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒãƒ¼ãƒˆã§å…¬é–‹
8. **ä¸¦è¡Œæ€§**: ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
9. **å»ƒæ£„å®¹æ˜“æ€§**: é«˜é€Ÿèµ·å‹•ãƒ»ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
10. **é–‹ç™ºãƒ»æœ¬ç•ªä¸€è‡´**: ç’°å¢ƒé–“ã®å·®ç•°æœ€å°åŒ–
11. **ãƒ­ã‚°**: ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æ‰±ã†
12. **ç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹**: ãƒ¯ãƒ³ã‚ªãƒ•ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œ

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ğŸŒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```mermaid
graph TB
    %% External
    User[ğŸ‘¤ User] --> LB[ğŸ”„ Load Balancer]
    Dev[ğŸ‘¨â€ğŸ’» Developer] --> CICD[ğŸš€ CI/CD Pipeline]
    
    %% Load Balancer & API Gateway
    LB --> APIGW[ğŸšª API Gateway]
    
    %% Frontend
    APIGW --> FE[ğŸ–¥ï¸ Frontend App]
    
    %% Microservices
    APIGW --> AUTH[ğŸ” Auth Service]
    APIGW --> MAP[ğŸ—ºï¸ Map Service]
    APIGW --> SEARCH[ğŸ” Search Service]
    APIGW --> ROUTE[ğŸ›£ï¸ Route Service]
    APIGW --> USER[ğŸ‘¤ User Service]
    
    %% Databases
    AUTH --> AUTHDB[(ğŸ—„ï¸ Auth DB)]
    USER --> USERDB[(ğŸ—„ï¸ User DB)]
    SEARCH --> SEARCHDB[(ğŸ” Search DB)]
    
    %% Cache & Message Queue
    AUTH --> REDIS[(ğŸ“¦ Redis Cache)]
    MAP --> REDIS
    SEARCH --> REDIS
    ROUTE --> REDIS
    USER --> REDIS
    
    ROUTE --> QUEUE[ğŸ“¨ Message Queue]
    
    %% External Services
    MAP --> TILES[ğŸ—ºï¸ Tile Server]
    SEARCH --> NOMINATIM[ğŸŒ Nominatim API]
    ROUTE --> OSRM[ğŸ›£ï¸ OSRM API]
    
    %% Monitoring & Logging
    AUTH --> METRICS[ğŸ“Š Prometheus]
    MAP --> METRICS
    SEARCH --> METRICS
    ROUTE --> METRICS
    USER --> METRICS
    
    AUTH --> LOGS[ğŸ“ Fluentd]
    MAP --> LOGS
    SEARCH --> LOGS
    ROUTE --> LOGS
    USER --> LOGS
    
    METRICS --> GRAFANA[ğŸ“ˆ Grafana]
    LOGS --> ELK[ğŸ” ELK Stack]
    
    %% Tracing
    AUTH --> JAEGER[ğŸ” Jaeger]
    MAP --> JAEGER
    SEARCH --> JAEGER
    ROUTE --> JAEGER
    USER --> JAEGER
    
    %% CI/CD
    CICD --> K8S[â˜¸ï¸ Kubernetes]
    K8S --> AUTH
    K8S --> MAP
    K8S --> SEARCH
    K8S --> ROUTE
    K8S --> USER
```

### ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```mermaid
sequenceDiagram
    participant U as User
    participant FE as Frontend
    participant GW as API Gateway
    participant AUTH as Auth Service
    participant MAP as Map Service
    participant SEARCH as Search Service
    participant ROUTE as Route Service
    participant USER as User Service
    participant CACHE as Redis Cache
    participant DB as Database
    
    %% Authentication Flow
    U->>FE: Login Request
    FE->>GW: POST /auth/login
    GW->>AUTH: Forward Request
    AUTH->>DB: Validate Credentials
    DB-->>AUTH: User Data
    AUTH->>CACHE: Store Session
    AUTH-->>GW: JWT Token
    GW-->>FE: Authentication Response
    FE-->>U: Login Success
    
    %% Map Display Flow
    U->>FE: Load Map
    FE->>GW: GET /maps/tiles/{z}/{x}/{y}
    GW->>MAP: Forward Request
    MAP->>CACHE: Check Cache
    alt Cache Hit
        CACHE-->>MAP: Cached Tile
    else Cache Miss
        MAP->>External: Fetch Tile
        External-->>MAP: Tile Data
        MAP->>CACHE: Store Cache
    end
    MAP-->>GW: Tile Response
    GW-->>FE: Tile Data
    FE-->>U: Display Map
    
    %% Search Flow
    U->>FE: Search Location
    FE->>GW: GET /search/geocode?q=location
    GW->>SEARCH: Forward Request
    SEARCH->>CACHE: Check Cache
    alt Cache Hit
        CACHE-->>SEARCH: Cached Results
    else Cache Miss
        SEARCH->>External: Nominatim API
        External-->>SEARCH: Search Results
        SEARCH->>CACHE: Store Cache
    end
    SEARCH-->>GW: Search Response
    GW-->>FE: Search Results
    FE-->>U: Display Results
    
    %% Route Calculation Flow
    U->>FE: Calculate Route
    FE->>GW: POST /routes/calculate
    GW->>ROUTE: Forward Request
    ROUTE->>CACHE: Check Cache
    alt Cache Hit
        CACHE-->>ROUTE: Cached Route
    else Cache Miss
        ROUTE->>External: OSRM API
        External-->>ROUTE: Route Data
        ROUTE->>CACHE: Store Cache
    end
    ROUTE-->>GW: Route Response
    GW-->>FE: Route Data
    FE-->>U: Display Route
    
    %% Bookmark Management Flow
    U->>FE: Save Bookmark
    FE->>GW: POST /users/bookmarks
    GW->>USER: Forward Request
    USER->>DB: Store Bookmark
    DB-->>USER: Success
    USER->>CACHE: Update Cache
    USER-->>GW: Success Response
    GW-->>FE: Bookmark Saved
    FE-->>U: Success Message
```

---

## ğŸ”§ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°è¨­è¨ˆ

### ğŸ” èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ (Auth Service)

#### è²¬ä»»ãƒ»æ©Ÿèƒ½
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªå¯**: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (RBAC)
- **ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†**: JWTç™ºè¡Œãƒ»æ¤œè¨¼ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†**: ãƒãƒƒã‚·ãƒ¥åŒ–ãƒ»ãƒªã‚»ãƒƒãƒˆãƒ»å¤‰æ›´
- **OAuth2.0/OIDC**: å¤–éƒ¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é€£æº

#### APIè¨­è¨ˆ
```yaml
openapi: 3.0.0
info:
  title: Auth Service API
  version: 2.1.0
paths:
  /auth/register:
    post:
      summary: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
      responses:
        '201':
          description: ç™»éŒ²æˆåŠŸ
        '400':
          description: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        '409':
          description: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¢å­˜
  
  /auth/login:
    post:
      summary: ãƒ­ã‚°ã‚¤ãƒ³
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
                  expiresIn:
                    type: integer
        '401':
          description: èªè¨¼å¤±æ•—
  
  /auth/refresh:
    post:
      summary: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸ
        '401':
          description: ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
  
  /auth/logout:
    post:
      summary: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```typescript
// User Entity
interface User {
  id: string;
  email: string;
  passwordHash: string;
  name: string;
  role: UserRole;
  isActive: boolean;
  emailVerified: boolean;
  createdAt: Date;
  updatedAt: Date;
  lastLoginAt?: Date;
}

enum UserRole {
  USER = 'user',
  ADMIN = 'admin',
  MODERATOR = 'moderator'
}

// Session Entity
interface Session {
  id: string;
  userId: string;
  accessToken: string;
  refreshToken: string;
  expiresAt: Date;
  createdAt: Date;
  ipAddress: string;
  userAgent: string;
}
```

#### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Runtime**: Node.js 20 + TypeScript 5
- **Framework**: Express.js + Helmet + CORS
- **Database**: PostgreSQL 15 (ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±)
- **Cache**: Redis 7 (ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³)
- **Security**: bcrypt + jsonwebtoken + passport
- **Validation**: Joi + express-validator
- **ORM**: Prisma 5

### ğŸ—ºï¸ åœ°å›³ã‚µãƒ¼ãƒ“ã‚¹ (Map Service)

#### è²¬ä»»ãƒ»æ©Ÿèƒ½
- **ã‚¿ã‚¤ãƒ«é…ä¿¡**: åœ°å›³ã‚¿ã‚¤ãƒ«ã®é«˜é€Ÿé…ä¿¡
- **ã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†**: åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ã®ç®¡ç†ãƒ»é…ä¿¡
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†**: ã‚¿ã‚¤ãƒ«ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- **CDNçµ±åˆ**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€£æº
- **ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã‚¹ã‚¿ã‚¤ãƒ«å¯¾å¿œ

#### APIè¨­è¨ˆ
```yaml
paths:
  /maps/tiles/{z}/{x}/{y}:
    get:
      summary: åœ°å›³ã‚¿ã‚¤ãƒ«å–å¾—
      parameters:
        - name: z
          in: path
          required: true
          schema:
            type: integer
            minimum: 0
            maximum: 18
        - name: x
          in: path
          required: true
          schema:
            type: integer
        - name: y
          in: path
          required: true
          schema:
            type: integer
        - name: style
          in: query
          schema:
            type: string
            enum: [standard, satellite, terrain, dark]
      responses:
        '200':
          description: ã‚¿ã‚¤ãƒ«ç”»åƒ
          content:
            image/png:
              schema:
                type: string
                format: binary
        '404':
          description: ã‚¿ã‚¤ãƒ«æœªç™ºè¦‹
  
  /maps/styles:
    get:
      summary: åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ä¸€è¦§
      responses:
        '200':
          description: ã‚¹ã‚¿ã‚¤ãƒ«ä¸€è¦§
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    description:
                      type: string
                    thumbnail:
                      type: string
                      format: uri
  
  /maps/styles/{styleId}:
    get:
      summary: åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«å–å¾—
      parameters:
        - name: styleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
          content:
            application/json:
              schema:
                type: object
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
interface TileCacheStrategy {
  // L1: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ (æœ€é »ç¹ã‚¢ã‚¯ã‚»ã‚¹)
  memoryCache: {
    maxSize: '512MB';
    ttl: '1hour';
    algorithm: 'LRU';
  };
  
  // L2: Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ (é«˜é »åº¦ã‚¢ã‚¯ã‚»ã‚¹)
  redisCache: {
    maxSize: '2GB';
    ttl: '24hours';
    keyPattern: 'tile:{style}:{z}:{x}:{y}';
  };
  
  // L3: CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ (ã‚°ãƒ­ãƒ¼ãƒãƒ«é…ä¿¡)
  cdnCache: {
    ttl: '7days';
    edgeLocations: 'global';
    compressionEnabled: true;
  };
}
```

#### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Runtime**: Node.js 20 + TypeScript 5
- **Framework**: Express.js + Sharp (ç”»åƒå‡¦ç†)
- **Tile Server**: TileServer GL + MapProxy
- **Cache**: Redis + CDN (CloudFlare/AWS CloudFront)
- **Storage**: S3 Compatible (MinIO/AWS S3)
- **Image Processing**: Sharp + ImageMagick

### ğŸ” æ¤œç´¢ã‚µãƒ¼ãƒ“ã‚¹ (Search Service)

#### è²¬ä»»ãƒ»æ©Ÿèƒ½
- **ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**: ä½æ‰€â†’åº§æ¨™å¤‰æ›
- **é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**: åº§æ¨™â†’ä½æ‰€å¤‰æ›
- **POIæ¤œç´¢**: èˆˆå‘³åœ°ç‚¹æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- **ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢å€™è£œ
- **æ¤œç´¢åˆ†æ**: æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»çµ±è¨ˆåˆ†æ

#### APIè¨­è¨ˆ
```yaml
paths:
  /search/geocode:
    get:
      summary: ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 2
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
        - name: countrycode
          in: query
          schema:
            type: string
            pattern: '^[a-z]{2}$'
        - name: bounded
          in: query
          schema:
            type: boolean
        - name: viewbox
          in: query
          schema:
            type: string
            pattern: '^-?\d+\.?\d*,-?\d+\.?\d*,-?\d+\.?\d*,-?\d+\.?\d*$'
      responses:
        '200':
          description: æ¤œç´¢çµæœ
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        place_id:
                          type: string
                        display_name:
                          type: string
                        lat:
                          type: number
                        lon:
                          type: number
                        boundingbox:
                          type: array
                          items:
                            type: number
                        class:
                          type: string
                        type:
                          type: string
                        importance:
                          type: number
  
  /search/reverse:
    get:
      summary: é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      parameters:
        - name: lat
          in: query
          required: true
          schema:
            type: number
            minimum: -90
            maximum: 90
        - name: lon
          in: query
          required: true
          schema:
            type: number
            minimum: -180
            maximum: 180
        - name: zoom
          in: query
          schema:
            type: integer
            minimum: 0
            maximum: 18
            default: 18
      responses:
        '200':
          description: é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ
  
  /search/autocomplete:
    get:
      summary: ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 5
      responses:
        '200':
          description: å€™è£œä¸€è¦§
```

#### æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
```json
{
  "mappings": {
    "properties": {
      "place_id": { "type": "keyword" },
      "display_name": { 
        "type": "text",
        "analyzer": "standard",
        "fields": {
          "suggest": {
            "type": "completion",
            "analyzer": "simple"
          }
        }
      },
      "location": { "type": "geo_point" },
      "boundingbox": { "type": "geo_shape" },
      "class": { "type": "keyword" },
      "type": { "type": "keyword" },
      "importance": { "type": "float" },
      "country_code": { "type": "keyword" },
      "admin_levels": {
        "type": "nested",
        "properties": {
          "level": { "type": "integer" },
          "name": { "type": "text" }
        }
      }
    }
  }
}
```

#### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Runtime**: Node.js 20 + TypeScript 5
- **Framework**: Express.js + Joi
- **Search Engine**: Elasticsearch 8 + OpenSearch
- **External API**: Nominatim + Overpass API
- **Cache**: Redis (æ¤œç´¢çµæœãƒ»å€™è£œ)
- **Queue**: Bull (é‡ã„æ¤œç´¢å‡¦ç†)

### ğŸ›£ï¸ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ (Route Service)

#### è²¬ä»»ãƒ»æ©Ÿèƒ½
- **çµŒè·¯è¨ˆç®—**: æœ€çŸ­ãƒ»æœ€é€Ÿãƒ«ãƒ¼ãƒˆè¨ˆç®—
- **äº¤é€šæ‰‹æ®µå¯¾å¿œ**: è»Šãƒ»å¾’æ­©ãƒ»è‡ªè»¢è»Šãƒ»å…¬å…±äº¤é€š
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€š**: äº¤é€šæƒ…å ±ãƒ»æ¸‹æ»è€ƒæ…®
- **çµŒè·¯æœ€é©åŒ–**: è¤‡æ•°åœ°ç‚¹æœ€é©åŒ–
- **ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚¿ãƒ¼ãƒ³ãƒã‚¤ã‚¿ãƒ¼ãƒ³æ¡ˆå†…

#### APIè¨­è¨ˆ
```yaml
paths:
  /routes/calculate:
    post:
      summary: çµŒè·¯è¨ˆç®—
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                coordinates:
                  type: array
                  items:
                    type: array
                    items:
                      type: number
                  minItems: 2
                profile:
                  type: string
                  enum: [driving, walking, cycling, public-transport]
                alternatives:
                  type: boolean
                  default: false
                steps:
                  type: boolean
                  default: true
                geometries:
                  type: string
                  enum: [geojson, polyline, polyline6]
                  default: geojson
                overview:
                  type: string
                  enum: [full, simplified, false]
                  default: simplified
      responses:
        '200':
          description: çµŒè·¯è¨ˆç®—çµæœ
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                  routes:
                    type: array
                    items:
                      type: object
                      properties:
                        geometry:
                          type: object
                        legs:
                          type: array
                        distance:
                          type: number
                        duration:
                          type: number
                        steps:
                          type: array
  
  /routes/optimize:
    post:
      summary: çµŒè·¯æœ€é©åŒ– (TSP)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                coordinates:
                  type: array
                  items:
                    type: array
                    items:
                      type: number
                  minItems: 3
                profile:
                  type: string
                  enum: [driving, walking, cycling]
                source:
                  type: string
                  enum: [first, any]
                  default: first
                destination:
                  type: string
                  enum: [last, any]
                  default: last
      responses:
        '200':
          description: æœ€é©åŒ–ã•ã‚ŒãŸçµŒè·¯
```

#### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆ
```typescript
// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³æŠ½è±¡åŒ–
interface RoutingEngine {
  calculateRoute(request: RouteRequest): Promise<RouteResponse>;
  calculateMatrix(request: MatrixRequest): Promise<MatrixResponse>;
  optimizeRoute(request: OptimizeRequest): Promise<OptimizeResponse>;
}

// OSRMå®Ÿè£…
class OSRMEngine implements RoutingEngine {
  private baseUrl: string;
  
  async calculateRoute(request: RouteRequest): Promise<RouteResponse> {
    const url = `${this.baseUrl}/route/v1/${request.profile}/${request.coordinates.join(';')}`;
    const params = new URLSearchParams({
      alternatives: request.alternatives.toString(),
      steps: request.steps.toString(),
      geometries: request.geometries,
      overview: request.overview
    });
    
    const response = await fetch(`${url}?${params}`);
    return response.json();
  }
}

// GraphHopperå®Ÿè£…
class GraphHopperEngine implements RoutingEngine {
  // GraphHopper APIå®Ÿè£…
}

// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹
class RouteService {
  private engines: Map<string, RoutingEngine>;
  
  constructor() {
    this.engines = new Map([
      ['osrm', new OSRMEngine()],
      ['graphhopper', new GraphHopperEngine()]
    ]);
  }
  
  async calculateRoute(request: RouteRequest): Promise<RouteResponse> {
    const engine = this.engines.get(request.engine || 'osrm');
    return engine.calculateRoute(request);
  }
}
```

#### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Runtime**: Node.js 20 + TypeScript 5
- **Framework**: Express.js + Turf.js
- **Routing Engine**: OSRM + GraphHopper
- **Cache**: Redis (çµŒè·¯ãƒ»äº¤é€šæƒ…å ±)
- **Queue**: Bull (é‡ã„è¨ˆç®—å‡¦ç†)
- **Geospatial**: PostGIS (é“è·¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)

### ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ (User Service)

#### è²¬ä»»ãƒ»æ©Ÿèƒ½
- **ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç®¡ç†**: åœ°ç‚¹ä¿å­˜ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ã‚«ãƒ†ã‚´ãƒªç®¡ç†
- **è¨­å®šç®¡ç†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ»ãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- **å±¥æ­´ç®¡ç†**: æ¤œç´¢ãƒ»ãƒ«ãƒ¼ãƒˆå±¥æ­´
- **ãƒ‡ãƒ¼ã‚¿åŒæœŸ**: ãƒ‡ãƒã‚¤ã‚¹é–“ãƒ‡ãƒ¼ã‚¿åŒæœŸ
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ãƒ»å‰Šé™¤æ¨©

#### APIè¨­è¨ˆ
```yaml
paths:
  /users/bookmarks:
    get:
      summary: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸€è¦§å–å¾—
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸€è¦§
    
    post:
      summary: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä½œæˆ
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                description:
                  type: string
                  maxLength: 500
                latitude:
                  type: number
                  minimum: -90
                  maximum: 90
                longitude:
                  type: number
                  minimum: -180
                  maximum: 180
                category:
                  type: string
                  maxLength: 50
                tags:
                  type: array
                  items:
                    type: string
                  maxItems: 10
      responses:
        '201':
          description: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä½œæˆæˆåŠŸ
  
  /users/bookmarks/{bookmarkId}:
    get:
      summary: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯è©³ç´°å–å¾—
      security:
        - bearerAuth: []
    
    put:
      summary: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ›´æ–°
      security:
        - bearerAuth: []
    
    delete:
      summary: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‰Šé™¤
      security:
        - bearerAuth: []
  
  /users/settings:
    get:
      summary: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå–å¾—
      security:
        - bearerAuth: []
    
    put:
      summary: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ›´æ–°
      security:
        - bearerAuth: []
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```typescript
// Bookmark Entity
interface Bookmark {
  id: string;
  userId: string;
  name: string;
  description?: string;
  latitude: number;
  longitude: number;
  category: string;
  tags: string[];
  isPublic: boolean;
  createdAt: Date;
  updatedAt: Date;
}

// UserSettings Entity
interface UserSettings {
  userId: string;
  language: string;
  theme: 'light' | 'dark' | 'auto';
  units: 'metric' | 'imperial';
  defaultMapStyle: string;
  notifications: {
    email: boolean;
    push: boolean;
    marketing: boolean;
  };
  privacy: {
    shareLocation: boolean;
    shareBookmarks: boolean;
    analytics: boolean;
  };
  updatedAt: Date;
}

// SearchHistory Entity
interface SearchHistory {
  id: string;
  userId: string;
  query: string;
  results: SearchResult[];
  timestamp: Date;
  location?: {
    latitude: number;
    longitude: number;
  };
}
```

#### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Runtime**: Node.js 20 + TypeScript 5
- **Framework**: Express.js + Prisma
- **Database**: PostgreSQL 15 (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿)
- **Cache**: Redis (è¨­å®šãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³)
- **Encryption**: AES-256-GCM (æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿)
- **Validation**: Joi + class-validator

---

## â˜¸ï¸ Kubernetesè¨­è¨ˆ

### ğŸ—ï¸ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹æˆ

#### Namespaceè¨­è¨ˆ
```yaml
# ã‚·ã‚¹ãƒ†ãƒ å…±é€š
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-system
  labels:
    name: kiro-system
    tier: system

---
# å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-auth
  labels:
    name: kiro-auth
    tier: application
    service: auth

---
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-map
  labels:
    name: kiro-map
    tier: application
    service: map

---
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-search
  labels:
    name: kiro-search
    tier: application
    service: search

---
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-route
  labels:
    name: kiro-route
    tier: application
    service: route

---
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-user
  labels:
    name: kiro-user
    tier: application
    service: user

---
# ç›£è¦–ãƒ»ãƒ­ã‚°
apiVersion: v1
kind: Namespace
metadata:
  name: kiro-monitoring
  labels:
    name: kiro-monitoring
    tier: monitoring
```

#### ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒ»è¦æ±‚
```yaml
# å„ã‚µãƒ¼ãƒ“ã‚¹å…±é€šãƒªã‚½ãƒ¼ã‚¹è¨­å®š
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒªã‚½ãƒ¼ã‚¹è¨­å®š
auth-service:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

map-service:
  requests:
    cpu: 200m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

search-service:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 2Gi

route-service:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

user-service:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi
```

### ğŸ”„ Deploymentè¨­è¨ˆ

#### èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ Deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: kiro-auth
  labels:
    app: auth-service
    version: v2.1.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
        version: v2.1.0
    spec:
      containers:
      - name: auth-service
        image: kiro/auth-service:v2.1.0
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "3000"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: auth-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: auth-secrets
              key: redis-url
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: auth-secrets
              key: jwt-secret
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      securityContext:
        fsGroup: 1000
```

#### Serviceè¨­è¨ˆ
```yaml
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: kiro-auth
  labels:
    app: auth-service
spec:
  selector:
    app: auth-service
  ports:
  - name: http
    port: 80
    targetPort: 3000
    protocol: TCP
  type: ClusterIP
```

#### Ingressè¨­è¨ˆ
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kiro-ingress
  namespace: kiro-system
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  tls:
  - hosts:
    - api.kiro-map.com
    secretName: kiro-tls
  rules:
  - host: api.kiro-map.com
    http:
      paths:
      - path: /auth(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: auth-service
            port:
              number: 80
      - path: /maps(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: map-service
            port:
              number: 80
      - path: /search(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: search-service
            port:
              number: 80
      - path: /routes(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: route-service
            port:
              number: 80
      - path: /users(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 80
```

### ğŸ” ConfigMapãƒ»Secretè¨­è¨ˆ

#### ConfigMap
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-config
  namespace: kiro-auth
data:
  NODE_ENV: "production"
  PORT: "3000"
  LOG_LEVEL: "info"
  JWT_EXPIRES_IN: "1h"
  REFRESH_TOKEN_EXPIRES_IN: "7d"
  BCRYPT_ROUNDS: "12"
  RATE_LIMIT_WINDOW: "900000"
  RATE_LIMIT_MAX: "100"
```

#### Secret
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: auth-secrets
  namespace: kiro-auth
type: Opaque
data:
  database-url: <base64-encoded-database-url>
  redis-url: <base64-encoded-redis-url>
  jwt-secret: <base64-encoded-jwt-secret>
  jwt-refresh-secret: <base64-encoded-jwt-refresh-secret>
```

---

## ğŸ“Š ç›£è¦–ãƒ»ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°è¨­è¨ˆ

### ğŸ“ˆ Prometheusç›£è¦–è¨­è¨ˆ

#### ServiceMonitorè¨­å®š
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: auth-service-monitor
  namespace: kiro-monitoring
  labels:
    app: auth-service
spec:
  selector:
    matchLabels:
      app: auth-service
  endpoints:
  - port: http
    path: /metrics
    interval: 30s
    scrapeTimeout: 10s
```

#### ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
```typescript
// Prometheus ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®šç¾©
import { register, Counter, Histogram, Gauge } from 'prom-client';

// HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹
const httpRequestsTotal = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code', 'service']
});

const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'service'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]
});

// èªè¨¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
const authAttemptsTotal = new Counter({
  name: 'auth_attempts_total',
  help: 'Total number of authentication attempts',
  labelNames: ['type', 'result']
});

const activeSessionsGauge = new Gauge({
  name: 'auth_active_sessions',
  help: 'Number of active user sessions'
});

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
const dbConnectionsActive = new Gauge({
  name: 'db_connections_active',
  help: 'Number of active database connections'
});

const dbQueryDuration = new Histogram({
  name: 'db_query_duration_seconds',
  help: 'Duration of database queries in seconds',
  labelNames: ['operation', 'table'],
  buckets: [0.01, 0.05, 0.1, 0.3, 0.5, 1, 3, 5]
});
```

### ğŸ“ æ§‹é€ åŒ–ãƒ­ã‚°è¨­è¨ˆ

#### ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
```typescript
// æ§‹é€ åŒ–ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
interface LogEntry {
  timestamp: string;
  level: 'debug' | 'info' | 'warn' | 'error';
  service: string;
  version: string;
  traceId?: string;
  spanId?: string;
  userId?: string;
  requestId: string;
  message: string;
  metadata?: Record<string, any>;
  error?: {
    name: string;
    message: string;
    stack: string;
  };
}

// ãƒ­ã‚°å‡ºåŠ›ä¾‹
{
  "timestamp": "2025-08-19T10:30:00.000Z",
  "level": "info",
  "service": "auth-service",
  "version": "v2.1.0",
  "traceId": "1234567890abcdef",
  "spanId": "abcdef1234567890",
  "userId": "user-123",
  "requestId": "req-456",
  "message": "User login successful",
  "metadata": {
    "email": "user@example.com",
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0..."
  }
}
```

#### Fluentdè¨­å®š
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kiro-monitoring
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*kiro*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      format json
      time_key timestamp
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>
    
    <filter kubernetes.**>
      @type kubernetes_metadata
    </filter>
    
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.kiro-monitoring.svc.cluster.local
      port 9200
      index_name kiro-logs
      type_name _doc
      include_tag_key true
      tag_key @log_name
      flush_interval 10s
    </match>
```

### ğŸ” åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°è¨­è¨ˆ

#### Jaegerè¨­å®š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: kiro-monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.47
        ports:
        - containerPort: 16686
          name: ui
        - containerPort: 14268
          name: collector
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
```

#### OpenTelemetryè¨ˆè£…
```typescript
// OpenTelemetryè¨­å®š
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { JaegerExporter } from '@opentelemetry/exporter-jaeger';

const jaegerExporter = new JaegerExporter({
  endpoint: 'http://jaeger.kiro-monitoring.svc.cluster.local:14268/api/traces',
});

const sdk = new NodeSDK({
  traceExporter: jaegerExporter,
  instrumentations: [getNodeAutoInstrumentations()],
  serviceName: 'auth-service',
  serviceVersion: 'v2.1.0',
});

sdk.start();

// ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ‘ãƒ³ä½œæˆ
import { trace } from '@opentelemetry/api';

const tracer = trace.getTracer('auth-service', 'v2.1.0');

async function authenticateUser(email: string, password: string) {
  const span = tracer.startSpan('authenticate_user');
  
  try {
    span.setAttributes({
      'user.email': email,
      'auth.method': 'password'
    });
    
    // èªè¨¼å‡¦ç†
    const user = await userService.findByEmail(email);
    const isValid = await bcrypt.compare(password, user.passwordHash);
    
    span.setAttributes({
      'auth.success': isValid,
      'user.id': user.id
    });
    
    return isValid ? user : null;
  } catch (error) {
    span.recordException(error);
    span.setStatus({ code: SpanStatusCode.ERROR });
    throw error;
  } finally {
    span.end();
  }
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### ğŸ›¡ï¸ ã‚µãƒ¼ãƒ“ã‚¹é–“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### mTLS (Mutual TLS)è¨­å®š
```yaml
# Istio ServiceMeshè¨­å®š
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: kiro-system
spec:
  mtls:
    mode: STRICT

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: auth-service-policy
  namespace: kiro-auth
spec:
  selector:
    matchLabels:
      app: auth-service
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/kiro-system/sa/api-gateway"]
  - to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/auth/*"]
```

#### API Gateway ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```typescript
// API Gateway ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
import rateLimit from 'express-rate-limit';
import helmet from 'helmet';
import cors from 'cors';

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 100, // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°åˆ¶é™
  message: 'Too many requests from this IP',
  standardHeaders: true,
  legacyHeaders: false,
  store: new RedisStore({
    client: redisClient,
    prefix: 'rl:'
  })
});

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.kiro-map.com"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// CORSè¨­å®š
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['https://kiro-map.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
}));

// JWTæ¤œè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
const verifyToken = async (req: Request, res: Response, next: NextFunction) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) {
      return res.status(401).json({ error: 'No token provided' });
    }
    
    const decoded = jwt.verify(token, process.env.JWT_SECRET!);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};
```

### ğŸ” Secretç®¡ç†

#### External Secrets Operator
```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: kiro-system
spec:
  provider:
    vault:
      server: "https://vault.kiro-system.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "kiro-role"

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-secrets
  namespace: kiro-auth
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: auth-secrets
    creationPolicy: Owner
  data:
  - secretKey: database-url
    remoteRef:
      key: auth-service
      property: database-url
  - secretKey: jwt-secret
    remoteRef:
      key: auth-service
      property: jwt-secret
```

---

## ğŸš€ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ

### ğŸ”„ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### Pull Request ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
```yaml
name: PR Validation
on:
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth, map, search, route, user]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'services/${{ matrix.service }}/package-lock.json'
    
    - name: Install dependencies
      run: |
        cd services/${{ matrix.service }}
        npm ci
    
    - name: Lint
      run: |
        cd services/${{ matrix.service }}
        npm run lint
    
    - name: Type check
      run: |
        cd services/${{ matrix.service }}
        npm run type-check
    
    - name: Unit tests
      run: |
        cd services/${{ matrix.service }}
        npm run test:unit
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: services/${{ matrix.service }}/coverage/lcov.info
        flags: ${{ matrix.service }}

  integration-test:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run integration tests
      run: npm run test:integration
      env:
        DATABASE_URL: postgresql://postgres:test@localhost:5432/test
        REDIS_URL: redis://localhost:6379

  security-scan:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Run OWASP ZAP scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:3000'
```

#### Main Branch ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
```yaml
name: Deploy to Production
on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth, map, search, route, user]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: services/${{ matrix.service }}
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/${{ matrix.service }}:latest
          ghcr.io/${{ github.repository }}/${{ matrix.service }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.12.0'
    
    - name: Deploy to staging
      run: |
        helm upgrade --install kiro-staging ./helm/kiro \
          --namespace kiro-staging \
          --create-namespace \
          --set image.tag=${{ github.sha }} \
          --set environment=staging \
          --wait --timeout=10m

  e2e-test:
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install
    
    - name: Run E2E tests
      run: npm run test:e2e
      env:
        BASE_URL: https://staging.kiro-map.com

  deploy-production:
    runs-on: ubuntu-latest
    needs: e2e-test
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
    
    - name: Deploy to production
      run: |
        helm upgrade --install kiro-production ./helm/kiro \
          --namespace kiro-production \
          --create-namespace \
          --set image.tag=${{ github.sha }} \
          --set environment=production \
          --wait --timeout=15m
    
    - name: Post-deploy verification
      run: |
        kubectl rollout status deployment/auth-service -n kiro-auth
        kubectl rollout status deployment/map-service -n kiro-map
        kubectl rollout status deployment/search-service -n kiro-search
        kubectl rollout status deployment/route-service -n kiro-route
        kubectl rollout status deployment/user-service -n kiro-user
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­è¨ˆ

### ğŸ¯ ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š

#### Horizontal Pod Autoscaler
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: auth-service-hpa
  namespace: kiro-auth
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
```

#### Vertical Pod Autoscaler
```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: auth-service-vpa
  namespace: kiro-auth
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth-service
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: auth-service
      maxAllowed:
        cpu: 1
        memory: 1Gi
      minAllowed:
        cpu: 100m
        memory: 128Mi
```

### ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### Redis Clusterè¨­å®š
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: kiro-system
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        command:
        - redis-server
        - /etc/redis/redis.conf
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - /data/nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --appendonly
        - "yes"
        volumeMounts:
        - name: data
          mountPath: /data
        - name: config
          mountPath: /etc/redis
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

#### CDNçµ±åˆ
```typescript
// CDNçµ±åˆè¨­å®š
interface CDNConfig {
  provider: 'cloudflare' | 'aws' | 'gcp';
  zones: {
    tiles: string;
    static: string;
    api: string;
  };
  caching: {
    tiles: {
      ttl: '7d';
      edgeCache: true;
      browserCache: '1d';
    };
    static: {
      ttl: '30d';
      edgeCache: true;
      browserCache: '7d';
    };
    api: {
      ttl: '5m';
      edgeCache: false;
      browserCache: '0';
    };
  };
}

// CDNã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…
class CDNService {
  async purgeCache(paths: string[]): Promise<void> {
    // CDN ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ãƒ¼ã‚¸å®Ÿè£…
  }
  
  async getEdgeLocations(): Promise<EdgeLocation[]> {
    // ã‚¨ãƒƒã‚¸ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
  }
  
  async getCacheStats(): Promise<CacheStats> {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆå–å¾—
  }
}
```

---

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ä½œæˆæ—¥**: 2025å¹´8æœˆ19æ—¥  
**ä½œæˆè€…**: Kiro AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…**: ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ  
**æ‰¿èªè€…**: CTO  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025å¹´8æœˆ26æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0