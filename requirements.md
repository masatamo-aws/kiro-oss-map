# 要件定義書 - OSS地図Webアプリ

## 1. プロジェクト概要

### 1.1 プロジェクト名
**kiro-oss-map** - オープンソース地図Webアプリケーション

### 1.2 目的・ゴール
- OSS とオープンデータ（主に OpenStreetMap）を活用したベクタ地図Webアプリの提供
- Google マップに類似した機能を持つ軽量で高速な地図サービスの実現
- MVP として「地図表示＋検索（住所/POI）＋経路（車/徒歩）＋地点共有」を3クリック以内で実現

### 1.3 プロジェクトの価値提案
- 完全オープンソースによる透明性とカスタマイズ性
- 商用利用可能なライセンス体系
- 自前ホスティング可能な独立性
- プライバシー重視の設計

## 2. スコープ定義

### 2.1 対象プラットフォーム
- **プライマリ**: Webブラウザ（PC/モバイル）
- **セカンダリ**: PWA対応（ホーム画面追加、オフライン簡易表示）

### 2.2 機能スコープ

#### 2.2.1 コア機能（MVP）
1. **地図表示機能**
   - パン/ズーム操作
   - 現在地取得・表示
   - レイヤ切替（標準/衛星/地形）
   - スタイル切替（昼/夜モード）

2. **検索機能**
   - 住所検索
   - ランドマーク検索
   - カテゴリ検索（カフェ、ATM、病院等）
   - 検索結果のマーカー表示

3. **経路探索機能**
   - 出発地/目的地設定
   - 車・徒歩ルート計算
   - ルート表示・案内

4. **共有機能**
   - URLパラメータによる地点共有
   - ルート共有
   - 短縮URL生成

#### 2.2.2 拡張機能（将来実装）
- 自転車・公共交通ルート
- 距離/面積計測ツール
- ブックマーク機能
- 印刷機能
- 埋め込み用コード生成
- 公開API提供

### 2.3 除外スコープ
- リアルタイム交通情報
- 商業施設の詳細情報（営業時間、レビュー等）
- ユーザーアカウント機能
- ソーシャル機能

## 3. ユーザー要件

### 3.1 想定ユーザー

#### 3.1.1 一般ユーザー
- **ニーズ**: 店舗検索、ナビゲーション代替
- **利用シーン**: 外出先での場所検索、経路確認
- **期待値**: 高速な地図表示、正確な検索結果

#### 3.1.2 事業部/社内利用者
- **ニーズ**: 軽量な地図埋め込み、簡易ルート提示
- **利用シーン**: 社内システムへの地図組み込み
- **期待値**: カスタマイズ性、安定性

#### 3.1.3 開発者
- **ニーズ**: 公開API、埋め込みウィジェット
- **利用シーン**: 他システムとの連携
- **期待値**: 豊富なAPI、詳細なドキュメント

### 3.2 ユーザーストーリー

#### US-001: 地図表示
**As a** 一般ユーザー  
**I want to** 地図を表示・操作したい  
**So that** 現在地や目的地を視覚的に確認できる

**受け入れ基準:**
- 地図が3秒以内に表示される
- スムーズなパン/ズーム操作が可能
- 現在地を1クリックで表示できる

#### US-002: 場所検索
**As a** 一般ユーザー  
**I want to** 住所や施設名で検索したい  
**So that** 目的地を素早く見つけられる

**受け入れ基準:**
- 検索結果が2秒以内に表示される
- 検索候補が入力中に表示される
- 検索結果がマーカーで地図上に表示される

#### US-003: 経路探索
**As a** 一般ユーザー  
**I want to** 出発地から目的地までのルートを知りたい  
**So that** 効率的に移動できる

**受け入れ基準:**
- ルート計算が5秒以内に完了する
- 車・徒歩の移動手段を選択できる
- 推定時間と距離が表示される

#### US-004: 地点共有
**As a** 一般ユーザー  
**I want to** 地点やルートを他人と共有したい  
**So that** 待ち合わせや案内ができる

**受け入れ基準:**
- 共有URLが1クリックで生成される
- 共有されたURLで同じ地点/ルートが表示される
- 短縮URLが利用できる

## 4. 技術要件

### 4.1 技術制約・前提

#### 4.1.1 オープンソース・オープンデータ利用
- **地図データ**: OpenStreetMap（ODbL準拠）
- **地図ライブラリ**: MapLibre GL JS
- **ルーティング**: OSRM または Valhalla
- **ジオコーディング**: Nominatim または Pelias
- **POI検索**: Overpass API

#### 4.1.2 ライセンス要件
- 商用利用可能なライセンス選定
- 依存ライブラリのライセンス整合性確保
- 必須表示義務の遵守（「© OpenStreetMap contributors」等）

#### 4.1.3 ホスティング要件
- 自前ホスティング前提
- 外部タイルサービスとの併用可能
- 利用規約順守

### 4.2 非機能要件

#### 4.2.1 パフォーマンス
- **地図初期表示**: 3秒以内
- **検索応答時間**: 2秒以内
- **ルート計算時間**: 5秒以内
- **タイル読み込み**: 1秒以内

#### 4.2.2 可用性
- **稼働率**: 99.5%以上
- **メンテナンス時間**: 月1回、2時間以内

#### 4.2.3 スケーラビリティ
- **同時接続数**: 1,000ユーザー対応
- **データ容量**: 100GB以上の地図データ処理

#### 4.2.4 セキュリティ
- HTTPS通信必須
- XSS/CSRF対策実装
- 個人情報最小化（位置許可は任意、座標匿名化）

#### 4.2.5 ユーザビリティ
- レスポンシブデザイン対応
- アクセシビリティ準拠（WCAG 2.1 AA）
- 多言語対応（日本語/英語）

#### 4.2.6 互換性
- **ブラウザ対応**: Chrome, Firefox, Safari, Edge（最新2バージョン）
- **モバイル対応**: iOS Safari, Android Chrome
- **PWA対応**: Service Worker, Web App Manifest

## 5. データ要件

### 5.1 地図データ
- **ソース**: OpenStreetMap
- **更新頻度**: 週次
- **カバレッジ**: 全世界（日本詳細）

### 5.2 検索データ
- **住所データ**: 国土地理院住所データ + OSM
- **POIデータ**: OpenStreetMap POI
- **カテゴリ**: 飲食店、医療機関、金融機関、公共施設等

### 5.3 ルーティングデータ
- **道路ネットワーク**: OpenStreetMap道路データ
- **交通規制**: OSM traffic規制情報
- **歩行者道**: 歩道・歩行者専用道路

## 6. インターフェース要件

### 6.1 ユーザーインターフェース
- **デザインシステム**: Material Design準拠
- **カラーパレット**: アクセシブルな配色
- **アイコン**: オープンソースアイコンセット使用

### 6.2 API要件
- **REST API**: 検索・ルーティング機能
- **WebSocket**: リアルタイム位置共有（将来）
- **埋め込みAPI**: iframe/JavaScript SDK

### 6.3 外部連携
- **タイルサーバー**: 複数プロバイダー対応
- **ジオコーディングAPI**: Nominatim/Pelias
- **ルーティングAPI**: OSRM/Valhalla

## 7. 運用要件

### 7.1 監視・ログ
- **アクセスログ**: 匿名化された利用統計
- **エラーログ**: システム障害検知
- **パフォーマンス監視**: 応答時間・リソース使用量

### 7.2 バックアップ・復旧
- **データバックアップ**: 日次自動バックアップ
- **設定バックアップ**: 構成管理
- **災害復旧**: RTO 4時間、RPO 24時間

### 7.3 更新・メンテナンス
- **地図データ更新**: 自動化された週次更新
- **システム更新**: 段階的デプロイメント
- **セキュリティパッチ**: 緊急時24時間以内適用

## 8. 制約・リスク

### 8.1 技術的制約
- OpenStreetMapデータの品質・完全性に依存
- オープンソースライブラリのサポート状況
- ブラウザAPI制限（位置情報、ストレージ等）

### 8.2 法的制約
- 各国の地図表示規制
- プライバシー法規制（GDPR、個人情報保護法等）
- オープンソースライセンス義務

### 8.3 運用リスク
- 外部APIサービスの可用性
- 地図データ更新の遅延
- 大量アクセス時のパフォーマンス劣化

## 9. 成功指標

### 9.1 技術指標
- 地図表示速度: 3秒以内達成率 95%以上
- 検索精度: 関連性スコア 0.8以上
- システム稼働率: 99.5%以上

### 9.2 ユーザー指標
- 月間アクティブユーザー: 1,000人以上
- セッション継続時間: 平均5分以上
- 機能利用率: 検索機能80%、ルート機能60%以上

### 9.3 ビジネス指標
- 開発コスト: 予算内完了
- 運用コスト: 月額$100以下
- コミュニティ貢献: GitHub Star 100以上

## 10. 今後の展開

### 10.1 フェーズ1（MVP）
- 基本地図表示・検索・ルーティング・共有機能
- PC/モバイル対応
- 期間: 3ヶ月

### 10.2 フェーズ2（機能拡張）
- PWA対応
- 計測ツール・ブックマーク機能
- 多言語対応
- 期間: 2ヶ月

### 10.3 フェーズ3（API公開）
- 公開API提供
- 埋め込みウィジェット
- 開発者ドキュメント
- 期間: 2ヶ月

## 11. 実装完了機能（v1.0.0）

### 11.1 完了した機能
- ✅ **地図表示機能**: MapLibre GL JS統合、複数レイヤー対応
- ✅ **検索機能**: Nominatim API統合、リアルタイム候補表示
- ✅ **検索結果表示**: カスタムピン、詳細ポップアップ、画像表示
- ✅ **経路探索機能**: OSRM API統合、車・徒歩ルート対応
- ✅ **共有機能**: URL共有、地点・ルート共有
- ✅ **位置情報サービス**: 現在地取得・表示
- ✅ **PWA対応**: Service Worker、オフライン機能
- ✅ **レスポンシブデザイン**: モバイル・タブレット・PC対応
- ✅ **ダークモード**: テーマ切り替え機能
- ✅ **画像統合**: Wikipedia・Unsplash画像自動取得
- ✅ **バージョン表示**: アプリ内バージョン情報表示

### 11.2 技術実装詳細
- **フロントエンド**: Vanilla JavaScript + Web Components
- **バックエンド**: Node.js + Express.js
- **ビルドシステム**: Vite
- **コンテナ化**: Docker + Docker Compose
- **アーキテクチャ**: イベント駆動、サービス指向設計
- **エラーハンドリング**: 包括的エラー処理とログ記録

### 11.3 パフォーマンス実績
- **地図初期表示**: 2秒以内（目標3秒以内を達成）
- **検索応答時間**: 1秒以内（目標2秒以内を達成）
- **ルート計算時間**: 3秒以内（目標5秒以内を達成）
- **画像キャッシュ**: 1時間キャッシュで高速表示

### 11.4 追加実装機能
- **ImageService**: 動的画像取得・キャッシュシステム
- **EventBus**: 中央集権イベント管理
- **Logger**: 構造化ログ記録
- **ErrorHandler**: グローバルエラーハンドリング
- **StorageService**: ローカルストレージ管理
- **ThemeService**: テーマ管理システム

---

**文書バージョン**: 2.0  
**作成日**: 2025年8月13日  
**最終更新**: 2025年8月13日  
**実装完了**: v1.0.0 - 2025年8月13日